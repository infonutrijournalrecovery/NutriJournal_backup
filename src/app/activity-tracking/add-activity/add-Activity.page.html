<ion-header>
    <ion-toolbar>
      <ion-title>Aggiungi attività fisica</ion-title>
      <ion-buttons slot="start">
        <ion-back-button [defaultHref]="getBackRoute()" text=""></ion-back-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  
  <ion-content class="add-Activity-content">
    
    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Caricamento...</p>
    </div>
  
    <!-- Main content -->
    <div *ngIf="!isLoading" class="Activity-container">
      
      <!-- Date and Activity Type Selection -->
      <ion-card class="Activity-config-card">
        <ion-card-content>
          <div class="config-row">
            <!-- Date Selection -->
            <div class="date-section">
              <ion-label>
                <h3>Data</h3>
              </ion-label>
              <ion-button 
                fill="outline" 
                (click)="openDatePicker()"
                class="date-button">
                <ion-icon name="calendar-outline" slot="start"></ion-icon>
                {{ formatDate(selectedDate) }}
              </ion-button>
            </div>
            
            <div class="Activity-type-section">
              <ion-label>
                <h3>Tipo Attività</h3>
              </ion-label>
              <ion-button 
                fill="outline" 
                (click)="openActivityTypeSelector()"
                class="Activity-type-button"
>
                
                {{ selectedActivityType || 'Seleziona tipo' }}
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
  
      <ion-card *ngIf="ActivityItems.length > 0" class="current-Activity-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="restaurant-outline"></ion-icon>
            Prodotti Aggiunti ({{ ActivityItems.length }})
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            <ion-item-sliding *ngFor="let item of ActivityItems; trackBy: trackByItemId">
              <ion-item>
                <ion-thumbnail slot="start" *ngIf="item.imageUrl">
                  <img [src]="item.imageUrl" [alt]="item.productName">
                </ion-thumbnail>
                <ion-icon 
                  *ngIf="!item.imageUrl" 
                  slot="start" 
                  [name]="getCategoryIcon(item.category)"
                  size="large">
                </ion-icon>
                
                <ion-label>
                  <h3>{{ item.productName }}</h3>
                  <p *ngIf="item.productBrand">{{ item.productBrand }}</p>
                  <p class="quantity-info">
                    {{ item.quantity }} {{ item.unit }} • 
                    <span class="calories">{{ Math.round(item.totalNutrition?.calories || 0) }} kcal</span>
                  </p>
                </ion-label>
                
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  size="small"
                  (click)="editItemQuantity(item)">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </ion-item>
              
              <ion-item-options slot="end">
                <ion-item-option (click)="removeItem(item)">
                  <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                </ion-item-option>
              </ion-item-options>
            </ion-item-sliding>
          </ion-list>
                  
        </ion-card-content>
      </ion-card>
  
      <ion-card class="add-products-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="add-circle-outline"></ion-icon>
            Aggiungi attività
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="add-methods">
            <ion-input
              type="number"
              min="1"
              placeholder="Durata in minuti"
              [(ngModel)]="activityDuration"
              required
              inputmode="numeric"
              name="activityDuration"
              id="activityDurationInput"
            ></ion-input>
            <div *ngIf="selectedActivityType && activityDuration && activityDuration > 0" class="calorie-preview" style="margin: 0.5em 0; color: var(--ion-color-primary);">
              Calorie stimate: <b>{{ calculatedCalories }}</b> kcal
            </div>
            <ion-button
              expand="block"
              fill="solid"
              class="add-method-button"
              [disabled]="!selectedActivityType || !activityDuration || activityDuration <= 0"
              (click)="saveActivity()">
              Conferma
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  
    <!-- Date Picker Modal -->
  <!-- Date picker modal handled dynamically by ModalController -->
  
    <!-- Activity Type Selector Modal -->
    <ion-modal #ActivityTypeModal [isOpen]="showActivityTypeSelector" (didDismiss)="showActivityTypeSelector = false">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Seleziona tipo attività</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeActivityTypeSelector()">Chiudi</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <ion-list>
            <ion-item 
              *ngFor="let type of ActivityTypes" 
              button 
              (click)="selectActivityType(type)">
              <ion-icon [name]="getActivityTypeIcon(type)" slot="start"></ion-icon>
              <ion-label>{{ type }}</ion-label>
              <ion-radio 
                slot="end" 
                [value]="type">
              </ion-radio>
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-modal>
  
  </ion-content>
  