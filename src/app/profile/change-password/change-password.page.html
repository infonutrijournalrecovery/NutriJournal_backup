<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/profile"></ion-back-button>
    </ion-buttons>
    <ion-title>Cambia Password</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="dots"></ion-spinner>
    <p>Aggiornamento password...</p>
  </div>

  <!-- Form Container -->
  <div class="change-password-container" *ngIf="!isLoading">
    
    <!-- Security Info Card -->
    <ion-card class="security-info-card">
      <ion-card-content>
        <div class="security-info">
          <ion-icon name="shield-checkmark-outline" color="primary"></ion-icon>
          <div class="info-text">
            <h3>Sicurezza Account</h3>
            <p>Per la tua sicurezza, ti chiediamo di inserire la password attuale prima di impostarne una nuova.</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Change Password Form -->
    <ion-card class="form-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="lock-closed-outline"></ion-icon>
          Modifica Password
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <form #passwordForm="ngForm" (ngSubmit)="changePassword()">
          
          <!-- Password Attuale -->
          <ion-item class="password-item" [class.item-error]="currentPasswordError">
            <ion-label position="stacked">Password Attuale *</ion-label>
            <ion-input
              name="currentPassword"
              [type]="showCurrentPassword ? 'text' : 'password'"
              [(ngModel)]="formData.currentPassword"
              #currentPassword="ngModel"
              required
              placeholder="Inserisci la password attuale"
              [class.input-error]="currentPasswordError"
              (ionInput)="clearErrors()">
            </ion-input>
            <ion-button
              slot="end"
              fill="clear"
              size="small"
              (click)="toggleCurrentPasswordVisibility()">
              <ion-icon [name]="showCurrentPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          <div *ngIf="currentPasswordError" class="error-message">
            {{ currentPasswordError }}
          </div>

          <!-- Nuova Password -->
          <ion-item class="password-item" [class.item-error]="newPasswordError">
            <ion-label position="stacked">Nuova Password *</ion-label>
            <ion-input
              name="newPassword"
              [type]="showNewPassword ? 'text' : 'password'"
              [(ngModel)]="formData.newPassword"
              #newPassword="ngModel"
              required
              minlength="8"
              placeholder="Inserisci la nuova password"
              [class.input-error]="newPasswordError"
              (ionInput)="validateNewPassword(); clearErrors()">
            </ion-input>
            <ion-button
              slot="end"
              fill="clear"
              size="small"
              (click)="toggleNewPasswordVisibility()">
              <ion-icon [name]="showNewPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          <div *ngIf="newPasswordError" class="error-message">
            {{ newPasswordError }}
          </div>

          <!-- Password Strength Indicator -->
          <div *ngIf="formData.newPassword" class="password-strength">
            <div class="strength-label">
              <span>Sicurezza password:</span>
              <span [class]="'strength-' + passwordStrength.level">{{ passwordStrength.label }}</span>
            </div>
            <div class="strength-bar">
              <div 
                class="strength-fill" 
                [class]="'strength-' + passwordStrength.level"
                [style.width.%]="passwordStrength.percentage">
              </div>
            </div>
            <div class="strength-requirements">
              <div 
                class="requirement" 
                [class.met]="passwordRequirements.minLength">
                <ion-icon [name]="passwordRequirements.minLength ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                Almeno 8 caratteri
              </div>
              <div 
                class="requirement" 
                [class.met]="passwordRequirements.hasUppercase">
                <ion-icon [name]="passwordRequirements.hasUppercase ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                Una lettera maiuscola
              </div>
              <div 
                class="requirement" 
                [class.met]="passwordRequirements.hasLowercase">
                <ion-icon [name]="passwordRequirements.hasLowercase ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                Una lettera minuscola
              </div>
              <div 
                class="requirement" 
                [class.met]="passwordRequirements.hasNumber">
                <ion-icon [name]="passwordRequirements.hasNumber ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                Un numero
              </div>
              <div 
                class="requirement" 
                [class.met]="passwordRequirements.hasSpecial">
                <ion-icon [name]="passwordRequirements.hasSpecial ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
                Un carattere speciale
              </div>
            </div>
          </div>

          <!-- Conferma Password -->
          <ion-item class="password-item" [class.item-error]="confirmPasswordError">
            <ion-label position="stacked">Conferma Nuova Password *</ion-label>
            <ion-input
              name="confirmPassword"
              [type]="showConfirmPassword ? 'text' : 'password'"
              [(ngModel)]="formData.confirmPassword"
              #confirmPassword="ngModel"
              required
              placeholder="Conferma la nuova password"
              [class.input-error]="confirmPasswordError"
              (ionInput)="validatePasswordMatch(); clearErrors()">
            </ion-input>
            <ion-button
              slot="end"
              fill="clear"
              size="small"
              (click)="toggleConfirmPasswordVisibility()">
              <ion-icon [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          <div *ngIf="confirmPasswordError" class="error-message">
            {{ confirmPasswordError }}
          </div>

          <!-- Match Indicator -->
          <div *ngIf="formData.newPassword && formData.confirmPassword" class="password-match">
            <ion-icon 
              [name]="passwordsMatch ? 'checkmark-circle' : 'close-circle'" 
              [color]="passwordsMatch ? 'success' : 'danger'">
            </ion-icon>
            <span [class]="passwordsMatch ? 'match-success' : 'match-error'">
              {{ passwordsMatch ? 'Le password corrispondono' : 'Le password non corrispondono' }}
            </span>
          </div>

          <!-- Submit Button -->
          <ion-button
            type="submit"
            expand="block"
            class="submit-button"
            [disabled]="!isFormValid() || isSubmitting"
            [color]="isFormValid() ? 'primary' : 'medium'">
            <ion-spinner *ngIf="isSubmitting" name="dots"></ion-spinner>
            <span *ngIf="!isSubmitting">
              <ion-icon name="checkmark-outline"></ion-icon>
              Cambia Password
            </span>
          </ion-button>

        </form>
      </ion-card-content>
    </ion-card>

    <!-- Security Tips -->
    <ion-card class="tips-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="bulb-outline"></ion-icon>
          Consigli per la Sicurezza
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list class="tips-list">
          <ion-item>
            <ion-icon name="shield-outline" slot="start" color="primary"></ion-icon>
            <ion-label class="ion-text-wrap">
              <h3>Password Unica</h3>
              <p>Usa una password diversa da quella di altri account</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="time-outline" slot="start" color="primary"></ion-icon>
            <ion-label class="ion-text-wrap">
              <h3>Aggiornamento Periodico</h3>
              <p>Cambia la password ogni 3-6 mesi per maggiore sicurezza</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="eye-off-outline" slot="start" color="primary"></ion-icon>
            <ion-label class="ion-text-wrap">
              <h3>Mantieni Privata</h3>
              <p>Non condividere mai la tua password con altri</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>