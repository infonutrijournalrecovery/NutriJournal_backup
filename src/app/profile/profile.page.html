<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/dashboard" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Profilo Utente</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onLogout()" color="danger">
        <ion-icon name="log-out-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="profile-content">
  
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="loadUserProfile($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Tira per aggiornare"
      refreshingSpinner="circles"
      refreshingText="Aggiornamento...">
    </ion-refresher-content>
  </ion-refresher>

  <div class="profile-container">
    
    <!-- Header con Avatar -->
    <div class="profile-header">
      <div class="avatar-section">
        <ion-avatar class="user-avatar">
          <img [src]="user?.avatar || 'assets/icon/default-avatar.png'" alt="Avatar utente">
        </ion-avatar>
        <ion-button fill="clear" size="small" class="edit-avatar-btn" (click)="changeAvatar()">
          <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
      <h1 class="user-name">{{ user?.name || 'Utente' }}</h1>
      <p class="user-email">{{ user?.email || '' }}</p>
      <div class="user-stats">
        <div class="stat-item">
          <span class="stat-number">{{ getDaysActive() }}</span>
          <span class="stat-label">Giorni attivo</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ user?.totalMeals || 0 }}</span>
          <span class="stat-label">Pasti registrati</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ user?.currentStreak || 0 }}</span>
          <span class="stat-label">Streak attuale</span>
        </div>
      </div>
    </div>

    <!-- Sezioni Profilo -->
    <div class="profile-sections">
      
      <!-- Dati Personali -->
      <ion-card class="profile-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="person-outline"></ion-icon>
            Dati Personali
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            <ion-item button (click)="editPersonalData()">
              <ion-icon slot="start" name="create-outline" color="primary"></ion-icon>
              <ion-label>
                <h3>Modifica informazioni di base</h3>
                <p>Nome, età, altezza, peso</p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>

            <ion-item button (click)="changePassword()">
              <ion-icon slot="start" name="lock-closed-outline" color="warning"></ion-icon>
              <ion-label>
                <h3>Cambia Password</h3>
                <p>Aggiorna la tua password di accesso</p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>
            
            <ion-item>
              <ion-icon slot="start" name="calendar-outline" color="medium"></ion-icon>
              <ion-label>
                <h3>Età</h3>
                <p>{{ getAge() }} anni</p>
              </ion-label>
            </ion-item>
            
            <ion-item>
              <ion-icon slot="start" name="resize-outline" color="medium"></ion-icon>
              <ion-label>
                <h3>Altezza</h3>
                <p>{{ user?.height || '--' }} cm</p>
              </ion-label>
            </ion-item>
            
            <ion-item>
              <ion-icon slot="start" name="scale-outline" color="medium"></ion-icon>
              <ion-label>
                <h3>Peso</h3>
                <p>{{ user?.weight || '--' }} kg</p>
              </ion-label>
            </ion-item>
            
            <ion-item button (click)="editAllergensAndAdditives()">
              <ion-icon slot="start" name="warning-outline" color="warning"></ion-icon>
              <ion-label>
                <h3>Allergeni e Additivi</h3>
                <p>Gestisci le tue allergie e sensibilità</p>
              </ion-label>
              <ion-badge 
                slot="end" 
                color="warning" 
                *ngIf="getTotalAllergensCount() > 0">
                {{ getTotalAllergensCount() }}
              </ion-badge>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>
            
            <!-- Lista allergeni selezionati (solo se presenti) -->
            <div *ngIf="hasAllergies()" class="allergens-preview">
              <div class="allergens-title">
                <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                <span>Allergeni ({{ getAllergiesCount() }})</span>
              </div>
              <div class="allergens-chips">
                <ion-chip 
                  *ngFor="let allergy of getAllergiesPreview()" 
                  [color]="getAllergySeverityColor(allergy.severity)"
                  outline>
                  <ion-icon name="warning-outline"></ion-icon>
                  <ion-label>{{ allergy.allergen_name }}</ion-label>
                </ion-chip>
                <ion-chip 
                  *ngIf="hasMoreAllergies()"
                  color="medium"
                  outline>
                  <ion-label>+{{ getAllergiesCount() - 3 }} altri</ion-label>
                </ion-chip>
              </div>
            </div>
            
            <!-- Lista additivi sensibili (solo se presenti) -->
            <div *ngIf="hasAdditives()" class="additives-preview">
              <div class="additives-title">
                <ion-icon name="flask-outline" color="warning"></ion-icon>
                <span>Additivi Sensibili ({{ getAdditivesCount() }})</span>
              </div>
              <div class="additives-chips">
                <ion-chip 
                  *ngFor="let additive of getAdditivesPreview()" 
                  [color]="getAdditiveSensitivityColor(additive.sensitivity_level)"
                  outline>
                  <ion-icon name="flask-outline"></ion-icon>
                  <ion-label>{{ additive.additive_name }}</ion-label>
                </ion-chip>
                <ion-chip 
                  *ngIf="hasMoreAdditives()"
                  color="medium"
                  outline>
                  <ion-label>+{{ getAdditivesCount() - 3 }} altri</ion-label>
                </ion-chip>
              </div>
            </div>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Obiettivi Nutrizionali -->
      <ion-card class="profile-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="trophy-outline"></ion-icon>
            Obiettivi Nutrizionali
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            <ion-item button (click)="viewGoals()">
              <ion-icon slot="start" name="analytics-outline" color="primary"></ion-icon>
              <ion-label>
                <h3>Visualizza Obiettivi</h3>
                <p>Personalizza i tuoi obiettivi</p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>
            
            <ion-item>
              <ion-icon slot="start" name="flame-outline" color="danger"></ion-icon>
              <ion-label>
                <h3>Calorie Giornaliere</h3>
                <p>{{ user?.nutritionGoals?.dailyCalories || '--' }} kcal</p>
              </ion-label>
            </ion-item>
            
            <ion-item>
              <ion-icon slot="start" name="fitness-outline" color="success"></ion-icon>
              <ion-label>
                <h3>Obiettivo</h3>
                <p>{{ getGoalLabel() }}</p>
              </ion-label>
            </ion-item>
            
            <ion-item>
              <ion-icon slot="start" name="trending-up-outline" color="warning"></ion-icon>
              <ion-label>
                <h3>Livello Attività</h3>
                <p>{{ getActivityLevelLabel() }}</p>
              </ion-label>
            </ion-item>

            <ion-item button (click)="viewDetailedStats()">
              <ion-icon slot="start" name="stats-chart-outline" color="primary"></ion-icon>
              <ion-label>
                <h3>Statistiche Dettagliate</h3>
                <p>Visualizza i tuoi progressi</p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>
            
            <ion-item button (click)="exportData()">
              <ion-icon slot="start" name="download-outline" color="success"></ion-icon>
              <ion-label>
                <h3>Esporta Dati</h3>
                <p>Scarica i tuoi dati in CSV/PDF</p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Preferenze App -->
      <ion-card class="profile-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="settings-outline"></ion-icon>
            Preferenze
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            <ion-item>
              <ion-icon slot="start" name="notifications-outline" color="primary"></ion-icon>
              <ion-label>
                <h3>Notifiche</h3>
                <p>Promemoria pasti e attività</p>
              </ion-label>
              <ion-toggle 
                slot="end" 
                [checked]="user?.preferences?.notifications || false"
                (ionChange)="toggleNotifications($event)">
              </ion-toggle>
            </ion-item>
            
            <ion-item>
              <ion-icon slot="start" name="moon-outline" color="medium"></ion-icon>
              <ion-label>
                <h3>Tema Scuro</h3>
                <p>Modalità scura dell'app</p>
              </ion-label>
              <ion-toggle 
                slot="end" 
                [checked]="user?.preferences?.darkMode || false"
                (ionChange)="toggleDarkMode($event)">
              </ion-toggle>
            </ion-item>

            
            
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Statistiche -->
      <ion-card class="profile-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="stats-chart-outline"></ion-icon>
            Le Tue Statistiche
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Zona Pericolo -->
      <ion-card class="profile-card danger-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="warning-outline"></ion-icon>
            Zona Pericolo
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="none">
            <ion-item button (click)="deleteAccount()">
              <ion-icon slot="start" name="trash-outline" color="danger"></ion-icon>
              <ion-label>
                <h3>Elimina Account</h3>
                <p>Rimuovi permanentemente il tuo account</p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Loading overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Caricamento...</p>
  </div>

</ion-content>
