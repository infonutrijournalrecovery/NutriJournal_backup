<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/pantry">i</ion-back-button>
    </ion-buttons>
    <ion-title>Visualizza prodotto</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ng-container *ngIf="prodotto; else loadingOrError">
    <ion-list lines="none" class="product-details">
      <ion-item>
        <ion-label>
          <strong>NOME:</strong>
          <div class="value">{{ prodotto.nome }}</div>
        </ion-label>
      </ion-item>
      <ion-item>
        <ion-label>
          <strong>MARCA:</strong>
          <div class="value">{{ prodotto.marca }}</div>
        </ion-label>
      </ion-item>
      <ion-item>
        <ion-label>
          <strong>QUANTITÀ:</strong>
          <div class="value">{{ prodotto.quantita }}</div>
        </ion-label>
      </ion-item>
      <ion-item>
        <ion-label>
          <strong>ADDITIVI:</strong>
          <div class="value-list">
            <div *ngIf="prodotto.additivi?.length; else noAdditivi">
              <div *ngFor="let additivo of prodotto.additivi" class="additivo-wrapper">
                <div class="additivo-pill"
                     [ngClass]="{
                       'Pericoloso': additivo.pericolosita === 2,
                       'Potenzialmente-pericoloso': additivo.pericolosita === 1,
                       'Innocuo': additivo.pericolosita === 0
                     }">
                  {{ additivo.nome }}
                </div>
                <span class="additivo-comment">
                  {{ additivo.pericolosita === 2 ? 'Pericoloso' : additivo.pericolosita === 1 ? 'Potenzialmente pericoloso' : 'Innocuo' }}
                </span>
              </div>
            </div>
            <ng-template #noAdditivi>Nessuno</ng-template>
          </div>
        </ion-label>
      </ion-item>
      <ion-item>
        <ion-label>
          <strong>ALLERGENI:</strong>
          <div class="value-list">
            <div *ngIf="prodotto.allergeni?.length; else noAllergeni">
              <div *ngFor="let allergene of prodotto.allergeni" class="allergene-wrapper">
                <div class="allergene-pill">
                  {{ allergene }}
                </div>
                <div *ngIf="isUserAllergic(allergene)" class="allergene-warning">
                  SEI ALLERGICO A QUESTO ALLERGENE!
                </div>
              </div>
            </div>
            <ng-template #noAllergeni>Nessuno</ng-template>
          </div>
        </ion-label>
      </ion-item>
      <ion-item >
        <ion-label>
          <h2><strong>Valori Nutrizionali</strong></h2>
          <div class="nutrient-list">
            <div class="nutrient">
              <span class="label">Energia:</span>
              <span class="value">{{ prodotto.nutrienti?.energia }} kcal</span>
            </div>
            <div class="nutrient">
              <span class="label">Carboidrati:</span>
              <span class="value">{{ prodotto.nutrienti?.carboidrati }} g</span>
            </div>
            <div class="nutrient">
              <span class="label">Grassi:</span>
              <span class="value">{{ prodotto.nutrienti?.grassi }} g</span>
            </div>
            <div class="nutrient">
              <span class="label">Proteine:</span>
              <span class="value">{{ prodotto.nutrienti?.proteine }} g</span>
            </div>
            <div class="nutrient">
              <span class="label">Sale:</span>
              <span class="value">{{ prodotto.nutrienti?.sale }} g</span>
            </div>
          </div>
        </ion-label>
      </ion-item>
      <ion-item>
        <div class="button-group">
          <div *ngIf="inPantry" class="pantry-status-msg" style="color: var(--ion-color-success); margin-bottom: 0.5em;">
            Prodotto già presente in dispensa (status: disponibile)
          </div>
          <ion-button fill="solid" [disabled]="inPantry" (click)="addToPantry()">
            {{ inPantry ? 'Già in dispensa' : 'Aggiungi in dispensa' }}
          </ion-button>
          <ion-button fill="solid" (click)="openMealActionSheet()">
            Aggiungi al pasto
          </ion-button>
        </div>
      </ion-item>
    </ion-list>
  </ng-container>
  <ng-template #loadingOrError>
    <ng-container *ngIf="prodotto === undefined; else notFoundBlock">
      <ion-spinner name="crescent"></ion-spinner>
    </ng-container>
    <ng-template #notFoundBlock>
      <div style="text-align:center; margin-top: 2rem; color: var(--ion-color-danger); font-weight: bold; font-size: 1.2em;">
        <ion-icon name="warning-outline" style="font-size:2em; vertical-align:middle;"></ion-icon>
        <div>Prodotto non trovato o errore di caricamento.</div>
      </div>
    </ng-template>
  </ng-template>
</ion-content>
