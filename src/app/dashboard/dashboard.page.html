<ion-content *ngIf="isDesktop" class="desktop-layout" [fullscreen]="true" scroll-y="true">
  <div class="desktop-welcome-header">
      <div class="welcome-content">
    <h1>üçé {{ getWelcomeMessage() }}<span *ngIf="user">, {{ user.name || 'Utente' }}!</span></h1>          
    <p class="welcome-subtitle">Il tuo NutriJournal</p>
      </div>
      <div class="user-profile-section">
          <ion-button fill="solid" class="profile-button" (click)="openUserProfile()">
              <ion-icon name="person-outline" slot="start"></ion-icon>
              Profilo
          </ion-button>
      </div>
  </div>
  <div class="page-centered">
      <div class="date-navigation-controls">
          <ion-button fill="solid" class="nav-btn" (click)="goToPreviousDay()">
              <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" class="date-display-btn" (click)="openDatePicker()">
              <ion-icon slot="start" name="calendar-outline"></ion-icon>
              {{ currentDate | date: 'EEEE, d MMMM y' }}
          </ion-button>
          <ion-button fill="solid" class="nav-btn" (click)="goToNextDay()" [disabled]="!canGoToNextDay()">
              <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button *ngIf="!isToday()" fill="outline" class="today-btn" (click)="goToToday()">
              Oggi
          </ion-button>
      </div>
  </div>
  <div class="desktop-grid">
      <div class="desktop-left-column">
          <!-- stato Nutrizionale -->
          <ion-card class="desktop-nutrition-card modern-nutrition">
              <ion-card-header>
                  <ion-card-title>
                      <ion-icon name="nutrition-outline"></ion-icon>
                      Stato Nutrizionale
                  </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                  <div class="semicircular-calories-section">
                      <div class="semicircular-progress-container">
                          <div class="separated-progress">
                              <svg *ngIf="!isLoading" class="semicircular-progress-overlay" viewBox="0 0 280 160" style="width: 100%; max-width: 280px; height: auto;">
                                  <path d="M 20 140 A 120 120 0 0 1 260 140" fill="transparent" stroke="#e0e0e0" stroke-width="16" stroke-linecap="round" />
                                  <path d="M 20 140 A 120 120 0 0 1 260 140" fill="transparent" [attr.stroke]="getCircularProgressColor(dailyStats.calories.percentage || 0)" stroke-width="16" stroke-linecap="round" [style.stroke-dasharray]="377.0" [style.stroke-dashoffset]="consumedCaloriesProgressOffset || 377.0" class="progress-semicircle consumed-outer" />
                                  <path d="M 55 140 A 85 85 0 0 1 225 140" fill="transparent" stroke="#f5f5f5" stroke-width="12" stroke-linecap="round" />
                                  <path d="M 55 140 A 85 85 0 0 1 225 140" fill="transparent" stroke="#ff9800" stroke-width="12" stroke-linecap="round" [style.stroke-dasharray]="267.0" [style.stroke-dashoffset]="burnedCaloriesProgressOffset || 267.0" class="progress-semicircle burned-inner" />
                              </svg>
                          </div>
                          <div class="calories-data-overlay">
                              <div class="calories-info-box consumed-box">
                                  <div class="calories-label">MANGIATE</div>
                                  <div class="calories-values">
                                      <span class="main-value">{{ dailyStats.calories.consumed || 0 }}</span>
                                      <span class="separator">/</span>
                                      <span class="goal-value">{{ dailyStats.calories.adjustedGoal || dailyStats.calories.goal || 0 }}</span>
                                  </div>
                                  <div class="calories-unit">kcal</div>
                              </div>
                              <div class="calories-info-box burned-box">
                                  <div class="calories-label">BRUCIATE</div>
                                  <div class="calories-values">
                                      <span class="main-value">{{ dailyStats.calories.burned || 0 }}</span>
                                  </div>
                                  <div class="calories-unit">kcal</div>
                              </div>
                          </div>
                          <div class="calories-summary-bottom">
                              <div class="remaining-calories" [ngClass]="{ 'positive': (dailyStats.calories.remaining || 0) > 0, 'negative': (dailyStats.calories.remaining || 0) <= 0 }">
                                  <ion-icon [name]="(dailyStats.calories.remaining || 0) > 0 ? 'checkmark-circle' : 'alert-circle'"></ion-icon>
                                  {{ (dailyStats.calories.remaining || 0) > 0 ? 'Rimangono ' + (dailyStats.calories.remaining || 0) + ' kcal' : 'Eccesso di ' + getMathAbs(dailyStats.calories.remaining || 0) + ' kcal' }}
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="macros-section">
                      <div class="macro-item proteins">
                          <div class="macro-header">
                              <ion-icon name="fitness-outline" class="macro-icon protein"></ion-icon>
                              <span class="macro-label">Proteine</span>
                              <span class="macro-values">{{ dailyStats.proteins.consumed || 0 }}/{{ dailyStats.proteins.goal || 0 }}g</span>
                          </div>
                          <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.proteins.percentage || 0) / 100" [color]="getProgressColor(dailyStats.proteins.percentage || 0)" class="macro-progress"></ion-progress-bar>
                      </div>
                      <div class="macro-item carbs">
                          <div class="macro-header">
                              <ion-icon name="restaurant-outline" class="macro-icon carb"></ion-icon>
                              <span class="macro-label">Carboidrati</span>
                              <span class="macro-values">{{ dailyStats.carbs.consumed || 0 }}/{{ dailyStats.carbs.goal || 0 }}g</span>
                          </div>
                          <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.carbs.percentage || 0) / 100" [color]="getProgressColor(dailyStats.carbs.percentage || 0)" class="macro-progress"></ion-progress-bar>
                      </div>
                      <div class="macro-item fats">
                          <div class="macro-header">
                              <ion-icon name="water-outline" class="macro-icon fat"></ion-icon>
                              <span class="macro-label">Grassi</span>
                              <span class="macro-values">{{ dailyStats.fats.consumed || 0 }}/{{ dailyStats.fats.goal || 0 }}g</span>
                          </div>
                          <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.fats.percentage || 0) / 100" [color]="getProgressColor(dailyStats.fats.percentage || 0)" class="macro-progress"></ion-progress-bar>
                      </div>
                      <div class="macro-item water">
                          <div class="macro-header">
                              <ion-icon name="fitness-outline" class="macro-icon water"></ion-icon>
                              <span class="macro-label">Acqua</span>
                              <span class="macro-values">{{ dailyStats.water.consumed || 0 }}/{{ dailyStats.water.goal || 0 }}ml</span>
                          </div>
                          <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.water.percentage || 0) / 100" [color]="getProgressColor(dailyStats.water.percentage || 0)" class="macro-progress"></ion-progress-bar>
                      </div>
                  </div>
              </ion-card-content>
          </ion-card>

          <!-- ativit√† di oggi -->
          <ion-card class="desktop-activities-card">
              <ion-card-header>
                  <ion-card-title>
                      <ion-icon name="trending-up-outline"></ion-icon>
                      Attivit√† di oggi
                  </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                    <ion-list class="desktop-activities-list">
                        <ng-container *ngIf="activitiesToday && activitiesToday.length > 0; else noActivities">
                          <ion-item *ngFor="let activity of activitiesToday" class="desktop-activity-item" lines="none">
                            <ion-label class="activity-info" lines="none">
                              <h4>{{ activity.name || getActivityLabel(activity.type || '') }}</h4>
                              <p>
                                {{ activity.duration_minutes || (activity.items && activity.items.length > 0 ? activity.items[0].quantity : '?') }} min
                                {{ activity.calories_burned || activity.totalNutrition?.calories || '?' }} kcal
                              </p>
                            </ion-label>
                            <ion-button class="elimina-btn" fill="outline" (click)="deleteActivity(activity)">
                                <ion-icon name="trash-outline"></ion-icon>
                              </ion-button>
                          </ion-item>
                        </ng-container>
                      
                        <ng-template #noActivities>
                          <ion-item class="desktop-empty-state" lines="none">
                            <ion-icon name="trending-up-outline" slot="start" style="color: #ff0000;"></ion-icon>
                            <ion-label>
                              <p>Nessuna attivit√† registrata</p>
                            </ion-label>
                          </ion-item>
                        </ng-template>
                      </ion-list>
                      
                  <div class="desktop-activity-add-btn-wrapper">
                      <ion-button fill="solid" size="small" class="action-btn activity-btn desktop-activity-add-btn" style="--border-color: #1976d2; --color: #ffffff; border-color: #1976d2 !important; color: #ffffff !important; font-size: 0.95rem; font-weight: 500; border-radius: 8px; padding: 0 18px; height: 36px;" (click)="goToActivity()">
                          <ion-icon slot="start" name="fitness-outline"></ion-icon>
                          + Registra Attivit√†
                      </ion-button>
                  </div>
                  <style>
                      .desktop-activities-list {
                          position: relative;
                          min-height: 265px;
                          padding-bottom: 56px;
                          overflow-y: auto;
                      }
                      .desktop-activity-add-btn-wrapper {
                          position: absolute;
                          left: 0;
                          right: 0;
                          bottom: 8px;
                          display: flex;
                          justify-content: center;
                          z-index: 2;
                      }
                  </style>
              </ion-card-content>
          </ion-card>
      </div>

      <div class="desktop-right-column">
          <!-- Gestione Pasti (dettagliata, sempre visibile su desktop) -->
          <ion-card class="desktop-meals-card desktop-meal-management">
              <ion-card-header>
                  <ion-card-title>
                      <ion-icon name="restaurant-outline"></ion-icon>
                      Gestione Pasti
                  </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <div class="scrollable-section">
                    <div class="meal-management-grid">
                      <div class="meal-section" *ngFor="let type of ['breakfast','lunch','snack','dinner']">
                          <div class="meal-header" (click)="openViewMeal(type)" style="cursor:pointer;">
                              <ion-icon [name]="getMealIcon(type)" class="meal-icon"></ion-icon>
                              <div class="meal-info">
                                  <h4 class="meal-name">{{ getMealName(type) }}</h4>
                              </div>
                          </div>
                          <div class="meal-content">
                              <ng-container *ngIf="!mealsByDateGrouped[type] || mealsByDateGrouped[type].length === 0">
                                  <div class="empty-meal">
                                      <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                                      <p class="empty-text">Nessun pasto aggiunto</p>
                                  </div>
                              </ng-container>
                              <ng-container *ngIf="mealsByDateGrouped[type] && mealsByDateGrouped[type].length > 0">
                                  <div class="meal-products-list" style="margin-top: 10px;">
                                      <ion-list lines="none">
                                          <ng-container *ngFor="let meal of mealsByDateGrouped[type]">
                                              <ng-container *ngIf="meal.items && meal.items.length > 0; else noProducts">
                                                  <ion-item *ngFor="let item of meal.items" class="product-item" lines="none">
                                                      <ion-label>
                                                          {{ item.product?.display_name || item.product?.name_it || item.product?.name || 'Prodotto' }}
                                                          <span *ngIf="item.quantity"> - {{ item.quantity }}{{ item.unit || 'g' }} 
                                                            <span *ngIf="meal.total_calories != null" style="float: right; color: #b0b0b0; font-size: 0.98em; font-weight: 500; margin-left: 12px;">  {{ meal.total_calories }} kcal</span>
                                                          </span>
                                                      </ion-label>
                                                  </ion-item>
                                              </ng-container>
                                              <ng-template #noProducts>
                                                  <ion-item lines="none">
                                                      <ion-label style="color: #c00; font-size: 0.95em;">Nessun prodotto trovato in questo pasto (id: {{ meal.id }})</ion-label>
                                                  </ion-item>
                                              </ng-template>
                                          </ng-container>
                                      </ion-list>
                                  </div>
                              </ng-container>
                              <div class="add-meal-btn-wrapper-fixed">
                                  <ion-button fill="solid" size="small" class="add-meal-btn" (click)="addMeal(type)">
                                      <ion-icon name="add-outline"></ion-icon>
                                      Aggiungi
                                  </ion-button>
                              </div>
                          </div>
                      </div>
                  </div>
                </div>
              </ion-card-content>
          </ion-card>

          <!-- azioni Rapide -->
          <ion-card class="desktop-activities-card">
              <ion-card-header>
                  <ion-card-title>
                      <ion-icon name="trending-up-outline"></ion-icon>
                      Azioni Rapide
                  </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                  <div class="button-container">
                      <ion-button fill="solid" class="action-btn scan-btn" [routerLink]="['/scanner']">
                          <ion-icon slot="start" name="barcode-outline"></ion-icon>
                          Scansiona prodotto
                      </ion-button>
                      <ion-button fill="solid" class="action-btn pantry-btn" [routerLink]="['/pantry']">
                          <ion-icon slot="start" name="fast-food-outline"></ion-icon>
                          Dispensa
                      </ion-button>
                        <ion-button fill="solid" class="action-btn vals-btn" [routerLink]="['/vals']">
                        <ion-icon slot="start" name="stats-chart-outline"></ion-icon>
                        I miei valori
                    </ion-button>
                  </div>
                  <ion-item lines="none">
                      <ion-item lines="none">
                          <ion-input type="number" [formControl]="waterAmount" label="ml"></ion-input>
                      </ion-item>
                      <ion-button fill="solid" class="action-btn water-btn" expand="block" (click)="confirmWater()">
                          <ion-icon slot="start" name="water-outline"></ion-icon>
                          Bevi acqua
                      </ion-button>
                  </ion-item>
                  <ion-item lines="none">
                    <div class="button-container">
                      <ion-button fill="solid" class="bicchiere-btn" expand="block" (click)="waterForm.get('waterAmount')?.setValue(100); confirmWater()">
                          Bicchiere piccolo (100ml)
                      </ion-button>
                      <ion-button fill="solid" class="bicchiere-btn" expand="block" (click)="waterForm.get('waterAmount')?.setValue(250); confirmWater()">
                          Bicchiere medio (250ml)
                      </ion-button>
                      <ion-button fill="solid" class="bicchiere-btn" expand="block" (click)="waterForm.get('waterAmount')?.setValue(500); confirmWater()">
                          Bottiglietta (500ml)
                      </ion-button>
                    </div>
                  </ion-item>
                  <ion-item lines="none">
                      <ion-item lines="none"> 
                          <ion-input type="number" [formControl]="weightAmount" label="kg"></ion-input>
                      </ion-item>
                      <ion-button fill="solid" class="action-btn weight-btn" expand="block" (click)="confirmWeight()">
                          <ion-icon slot="start" name="scale-outline"></ion-icon>
                          Aggiungi peso giornaliero
                      </ion-button>
                  </ion-item>
              </ion-card-content>
          </ion-card>
      </div>
  </div>
</ion-content>


<!-- mobile layout -->
<ion-content *ngIf="!isDesktop" class="desktop-layout" [fullscreen]="true" scroll-y="true">
  <div class="desktop-welcome-header">
    <div class="welcome-content">
        <h1>{{ getWelcomeMessage() }}<span *ngIf="user">, {{ user.name }}!</span></h1>
        <p class="welcome-subtitle">Dashboard nutrizionale e attivit√† fisica</p>
    </div>
    <div class="user-profile-section">
        <ion-button fill="solid" class="profile-button" (click)="openUserProfile()">
            <ion-icon name="person-outline" slot="start"></ion-icon>
            Profilo
        </ion-button>
    </div>
  </div>
  <div class="page-centered">
      <div class="date-navigation-controls">
          <ion-button fill="solid" class="nav-btn" (click)="goToPreviousDay()">
              <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" class="date-display-btn" (click)="openDatePicker()">
              <ion-icon slot="start" name="calendar-outline"></ion-icon>
              {{ currentDate | date: 'EEEE, d MMMM y' }}
          </ion-button>
          <ion-button fill="solid" class="nav-btn" (click)="goToNextDay()" [disabled]="!canGoToNextDay()">
              <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button *ngIf="!isToday()" fill="outline" class="today-btn" (click)="goToToday()">
              Oggi
          </ion-button>
      </div>
  </div>
  <div class="mobile-grid">
    <!-- Nutrizione -->
    <ion-card class="desktop-nutrition-card modern-nutrition">
          <ion-card-header>
              <ion-card-title>
                  <ion-icon name="nutrition-outline"></ion-icon>
                  Stato Nutrizionale
              </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="semicircular-calories-section">
              <div class="semicircular-progress-container">
                  <div class="separated-progress">
                      <svg *ngIf="!isLoading" class="semicircular-progress-overlay" viewBox="0 0 280 160" style="width: 100%; max-width: 280px; height: auto;">
                          <path d="M 20 140 A 120 120 0 0 1 260 140" fill="transparent" stroke="#e0e0e0" stroke-width="16" stroke-linecap="round" />
                          <path d="M 20 140 A 120 120 0 0 1 260 140" fill="transparent" [attr.stroke]="getCircularProgressColor(dailyStats.calories.percentage || 0)" stroke-width="16" stroke-linecap="round" [style.stroke-dasharray]="377.0" [style.stroke-dashoffset]="consumedCaloriesProgressOffset || 377.0" class="progress-semicircle consumed-outer" />
                          <path d="M 55 140 A 85 85 0 0 1 225 140" fill="transparent" stroke="#f5f5f5" stroke-width="12" stroke-linecap="round" />
                          <path d="M 55 140 A 85 85 0 0 1 225 140" fill="transparent" stroke="#ff9800" stroke-width="12" stroke-linecap="round" [style.stroke-dasharray]="267.0" [style.stroke-dashoffset]="burnedCaloriesProgressOffset || 267.0" class="progress-semicircle burned-inner" />
                      </svg>
                  </div>
                  <div class="calories-data-overlay">
                      <div class="calories-info-box consumed-box">
                          <div class="calories-label">MANGIATE</div>
                          <div class="calories-values">
                              <span class="main-value">{{ dailyStats.calories.consumed || 0 }}</span>
                              <span class="separator">/</span>
                              <span class="goal-value">{{ dailyStats.calories.adjustedGoal || dailyStats.calories.goal || 0 }}</span>
                          </div>
                          <div class="calories-unit">kcal</div>
                      </div>
                      <div class="calories-info-box burned-box">
                          <div class="calories-label">BRUCIATE</div>
                          <div class="calories-values">
                              <span class="main-value">{{ dailyStats.calories.burned || 0 }}</span>
                          </div>
                          <div class="calories-unit">kcal</div>
                      </div>
                  </div>
                  <div class="calories-summary-bottom">
                      <div class="remaining-calories" [ngClass]="{ 'positive': (dailyStats.calories.remaining || 0) > 0, 'negative': (dailyStats.calories.remaining || 0) <= 0 }">
                          <ion-icon [name]="(dailyStats.calories.remaining || 0) > 0 ? 'checkmark-circle' : 'alert-circle'"></ion-icon>
                          {{ (dailyStats.calories.remaining || 0) > 0 ? 'Rimangono ' + (dailyStats.calories.remaining || 0) + ' kcal' : 'Eccesso di ' + getMathAbs(dailyStats.calories.remaining || 0) + ' kcal' }}
                      </div>
                  </div>
              </div>
          </div>
          <div class="macros-section">
              <div class="macro-item proteins">
                  <div class="macro-header">
                      <ion-icon name="fitness-outline" class="macro-icon protein"></ion-icon>
                      <span class="macro-label">Proteine</span>
                      <span class="macro-values">{{ dailyStats.proteins.consumed || 0 }}/{{ dailyStats.proteins.goal || 0 }}g</span>
                  </div>
                  <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.proteins.percentage || 0) / 100" [color]="getProgressColor(dailyStats.proteins.percentage || 0)" class="macro-progress"></ion-progress-bar>
              </div>
              <div class="macro-item carbs">
                  <div class="macro-header">
                      <ion-icon name="restaurant-outline" class="macro-icon carb"></ion-icon>
                      <span class="macro-label">Carboidrati</span>
                      <span class="macro-values">{{ dailyStats.carbs.consumed || 0 }}/{{ dailyStats.carbs.goal || 0 }}g</span>
                  </div>
                  <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.carbs.percentage || 0) / 100" [color]="getProgressColor(dailyStats.carbs.percentage || 0)" class="macro-progress"></ion-progress-bar>
              </div>
              <div class="macro-item fats">
                  <div class="macro-header">
                      <ion-icon name="water-outline" class="macro-icon fat"></ion-icon>
                      <span class="macro-label">Grassi</span>
                      <span class="macro-values">{{ dailyStats.fats.consumed || 0 }}/{{ dailyStats.fats.goal || 0 }}g</span>
                  </div>
                  <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.fats.percentage || 0) / 100" [color]="getProgressColor(dailyStats.fats.percentage || 0)" class="macro-progress"></ion-progress-bar>
              </div>
              <div class="macro-item water">
                  <div class="macro-header">
                      <ion-icon name="fitness-outline" class="macro-icon water"></ion-icon>
                      <span class="macro-label">Acqua</span>
                      <span class="macro-values">{{ dailyStats.water.consumed || 0 }}/{{ dailyStats.water.goal || 0 }}ml</span>
                  </div>
                  <ion-progress-bar *ngIf="!isLoading" [value]="(dailyStats.water.percentage || 0) / 100" [color]="getProgressColor(dailyStats.water.percentage || 0)" class="macro-progress"></ion-progress-bar>
              </div>
          </div>
          </ion-card-content>
      </ion-card>
      <!-- Attivit√† -->
      <ion-card class="desktop-activities-card">
          <ion-card-header>
              <ion-card-title>
                  <ion-icon name="trending-up-outline"></ion-icon>
                  Attivit√† di oggi
              </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="desktop-activities-list">
              <ng-container *ngIf="activitiesToday && activitiesToday.length > 0; else noActivities">
                  <div *ngFor="let activity of activitiesToday" class="desktop-activity-item">
                      <div class="activity-info">
                          <h4>{{ activity.name || getActivityLabel(activity.type || '') }}</h4>
                          <p>
                              {{ activity.duration_minutes || (activity.items && activity.items.length > 0 ? activity.items[0].quantity : '?') }} min \u2022
                              {{ activity.calories_burned || activity.totalNutrition?.calories || '?' }} kcal
                          </p>
                      </div>
                  </div>
              </ng-container>
              <ng-template #noActivities>
                  <div class="desktop-empty-state">
                      <ion-icon name="trending-up-outline" style="color: #ff0000;"></ion-icon>
                      <p>Nessuna attivit√† registrata</p>
                  </div>
              </ng-template>
          </div>
          <div class="desktop-activity-add-btn-wrapper">
              <ion-button fill="solid" size="small" class="action-btn activity-btn desktop-activity-add-btn" style="--border-color: #1976d2; --color: #ffffff; border-color: #1976d2 !important; color: #ffffff !important; font-size: 0.95rem; font-weight: 500; border-radius: 8px; padding: 0 18px; height: 36px;" (click)="goToActivity()">
                  <ion-icon slot="start" name="fitness-outline"></ion-icon>
                  + Registra Attivit√†
              </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
      <!-- Gestione Pasti (mobile, stile desktop) -->
      <ion-card class="desktop-meals-card desktop-meal-management">
          <ion-card-header>
              <ion-card-title>
                  <ion-icon name="restaurant-outline"></ion-icon>
                  Gestione Pasti
              </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="meal-management-grid">
            <div class="meal-section" *ngFor="let type of ['breakfast','lunch','snack','dinner']" (click)="openViewMeal(type)" style="cursor:pointer;">
                <div class="meal-header">
                    <ion-icon [name]="getMealIcon(type)" class="meal-icon"></ion-icon>
                    <div class="meal-info">
                        <h4 class="meal-name">{{ getMealName(type) }}</h4>
                        <p class="meal-calories">{{ getMealStats(type).calories.consumed }} / {{ getMealStats(type).calories.goal }} kcal</p>
                    </div>
                </div>
                <div class="meal-content">
                    <ng-container *ngIf="!mealsByDateGrouped[type] || mealsByDateGrouped[type].length === 0">
                        <div class="empty-meal">
                            <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                            <p class="empty-text">Nessun pasto aggiunto</p>
                            <ion-button fill="solid" size="small" class="add-meal-btn" (click)="addMeal(type)">
                                <ion-icon name="add-outline"></ion-icon>
                                Aggiungi
                            </ion-button>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="mealsByDateGrouped[type] && mealsByDateGrouped[type].length > 0">
                        <div class="meal-products-list" style="margin-top: 10px;">
                            <ion-list lines="none">
                                <ng-container *ngFor="let meal of mealsByDateGrouped[type]">
                                    <ion-item class="meal-summary-item">
                                        <ion-label>
                                            <b>{{ getMealName(type) }}</b>
                                            <span *ngIf="meal.total_calories != null" style="float: right; color: #b0b0b0; font-size: 0.98em; font-weight: 500; margin-left: 12px;">{{ meal.total_calories }} kcal</span>
                                        </ion-label>
                                    </ion-item>
                                    <ng-container *ngIf="meal.items && meal.items.length > 0; else noProducts">
                                        <ion-item *ngFor="let item of meal.items" class="product-item" lines="none">
                                            <ion-label>
                                                {{ item.product?.display_name || item.product?.name_it || item.product?.name || 'Prodotto' }}
                                                <span *ngIf="item.quantity"> - {{ item.quantity }}{{ item.unit || 'g' }}</span>
                                            </ion-label>
                                        </ion-item>
                                    </ng-container>
                                    <ng-template #noProducts>
                                        <ion-item lines="none">
                                            <ion-label style="color: #c00; font-size: 0.95em;">Nessun prodotto trovato in questo pasto (id: {{ meal.id }})</ion-label>
                                        </ion-item>
                                    </ng-template>
                                </ng-container>
                            </ion-list>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
     </ion-card-content>
      </ion-card>
      <!-- Azioni rapide -->
        <ion-card class="desktop-activities-card">
                    <ion-card-header>
              <ion-card-title>
                  <ion-icon name="trending-up-outline"></ion-icon>
                  Azioni Rapide
              </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="button-container-mobile">
              <ion-button fill="solid" class="action-btn-mobile scan-btn" [routerLink]="['/scanner']">
                  <ion-icon slot="start" name="barcode-outline"></ion-icon>
                  Scansiona prodotto
              </ion-button>
              <ion-button fill="solid" class="action-btn-mobile pantry-btn" [routerLink]="['/pantry']">
                  <ion-icon slot="start" name="fast-food-outline"></ion-icon>
                  Dispensa
              </ion-button>
              <ion-button fill="solid" class="action-btn-mobile vals-btn" [routerLink]="['/vals']">
                <ion-icon slot="start" name="stats-chart-outline"></ion-icon>
                I miei valori
            </ion-button>
          </div>
          <ion-item lines="none">
              <ion-item lines="none">
                  <ion-input type="number" [formControl]="waterAmount" label="ml"></ion-input>
              </ion-item>
              <ion-button fill="solid" class="action-btn water-btn" expand="block" (click)="confirmWater()">
                  <ion-icon slot="start" name="water-outline"></ion-icon>
                  Bevi acqua
              </ion-button>
          </ion-item>
          <ion-item lines="none">
            <div class="button-container-mobile">
              <ion-button fill="solid" class="bicchiere-btn-mobile" expand="block" (click)="waterForm.get('waterAmount')?.setValue(100); confirmWater()">
                  Bicchiere piccolo (100ml)
              </ion-button>
              <ion-button fill="solid" class="bicchiere-btn-mobile" expand="block" (click)="waterForm.get('waterAmount')?.setValue(250); confirmWater()">
                  Bicchiere medio (250ml)
              </ion-button>
              <ion-button fill="solid" class="bicchiere-btn-mobile" expand="block" (click)="waterForm.get('waterAmount')?.setValue(500); confirmWater()">
                  Bottiglietta (500ml)
              </ion-button>
            </div>
          </ion-item>
          <ion-item lines="none">
              <ion-item lines="none"> 
                  <ion-input type="number" [formControl]="weightAmount" label="kg"></ion-input>
              </ion-item>
              <ion-button fill="solid" class="action-btn weight-btn" expand="block" (click)="confirmWeight()">
                  <ion-icon slot="start" name="scale-outline"></ion-icon>
                  Aggiungi peso giornaliero
              </ion-button>
          </ion-item>          
        </ion-card-content>
      </ion-card>
  </div>
</ion-content>