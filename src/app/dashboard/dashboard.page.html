<!-- Dashboard Header 
<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      <span *ngIf="!isDesktop">NutriJournal</span>
      <span *ngIf="isDesktop">DasAhboard - NutriJournal</span>
    </ion-title>
  </ion-toolbar>
</ion-header>  -->

<ion-content [fullscreen]="true" [class]="'dashboard-content ' + deviceLayout" style="--background: #f8f9fb; background-color: #f8f9fb !important;">
  
  <!-- Refresher (solo mobile) -->
  <ion-refresher *ngIf="isMobile" slot="fixed" (ionRefresh)="loadDashboardData($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Tira per aggiornare"
      refreshingSpinner="circles"
      refreshingText="Aggiornamento...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Layout Desktop -->
  <div *ngIf="isDesktop" class="desktop-layout">
    
    <!-- Header Desktop -->
    <div class="desktop-welcome-header">
      <div class="welcome-content">
        <h1>{{ getWelcomeMessage() }}<span *ngIf="user">, {{ user.name }}!</span></h1>
        <p class="welcome-subtitle">Dashboard nutrizionale e attività fisica</p>
      </div>
      <!-- User Profile Button -->
      <div class="user-profile-section">
        <ion-button 
          fill="solid" 
          class="profile-button"
          (click)="openUserProfile()">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          Profilo
        </ion-button>
      </div>
    </div>


              
             <!-- Controlli di navigazione temporale -->
<div class="page-centered">
  <div class="date-navigation-controls">
    
    <!-- Pulsante Giorno Precedente -->
    <ion-button 
      fill="solid" 
      class="nav-btn"
      (click)="goToPreviousDay()">
      <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
    </ion-button>

    <!-- Pulsante con la Data -->
    <ion-button
      fill="clear"
      class="date-display-btn"
      (click)="openDatePicker()">
      <ion-icon slot="start" name="calendar-outline"></ion-icon>
      {{ selectedDate | date: 'EEEE, d MMMM y' }}
    </ion-button>

    <!-- Modal con IonDatetime -->
    <ion-modal [isOpen]="isDatePickerOpen" (didDismiss)="closeDatePicker()">
      <ng-template>
        <ion-content>
          <ion-datetime
            presentation="date"
            [value]="selectedDate"
            (ionChange)="onDateSelected($event)">
          </ion-datetime>
          <ion-button expand="block" (click)="closeDatePicker()">Chiudi</ion-button>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- Pulsante Giorno Successivo -->
    <ion-button 
      fill="solid" 
      class="nav-btn"
      (click)="goToNextDay()"
      [disabled]="!canGoToNextDay()">
      <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
    </ion-button>

    <!-- Pulsante "Oggi" -->
    <ion-button 
      *ngIf="!isToday()"
      fill="outline" 
      class="today-btn"
      (click)="goToToday()">
      Oggi
    </ion-button>

  </div>
</div>


    <!-- Content Desktop in Grid -->
    <div class="desktop-grid">
    
      <!-- Colonna Sinistra -->
      <div class="desktop-left-column">

        
        
        <!-- Nutrition Progress Desktop - NUOVA VERSIONE -->
        <ion-card class="desktop-nutrition-card modern-nutrition" style="--background: #ffffff; background-color: #ffffff !important; box-shadow: 0 4px 16px rgba(0,0,0,0.1) !important;">
          <ion-card-header style="--background: #e8f0fe; background-color: #e8f0fe !important; --color: #001d35; color: #001d35 !important;">
            <ion-card-title style="--color: #001d35; color: #001d35 !important; font-weight: 600 !important;">
              <ion-icon name="nutrition-outline"></ion-icon>
              Stato Nutrizionale
              
              <!-- Controlli di navigazione temporale 
              <div class="date-navigation-controls" style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                <ion-button 
                  fill="clear" 
                  size="small" 
                  (click)="goToPreviousDay()"
                  style="--color: #1976d2; color: #1976d2 !important;">
                  <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <div class="date-display" style="flex: 1; text-align: center; font-weight: 500; font-size: 0.9rem;">
                  {{ getDateDisplayText() }}
                </div>
                
                <ion-button 
                  fill="clear" 
                  size="small" 
                  (click)="goToNextDay()"
                  [disabled]="!canGoToNextDay()"
                  style="--color: #1976d2; color: #1976d2 !important;">
                  <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <ion-button 
                  *ngIf="!isToday()"
                  fill="outline" 
                  size="small" 
                  (click)="goToToday()"
                  style="--border-color: #1976d2; --color: #1976d2; border-color: #1976d2 !important; color: #1976d2 !important; font-size: 0.8rem; height: 28px;">
                  Oggi
                </ion-button>
              </div> -->
            </ion-card-title>
          </ion-card-header>
          <ion-card-content style="--background: #ffffff; background-color: #ffffff !important; --color: #1a1c1e; color: #1a1c1e !important;">
            
            <!-- Semicircular Progress per Calorie Sovrapposte -->
            <div class="semicircular-calories-section">
              <div class="semicircular-progress-container">
                
                <!-- SVG con progress bar semicircolari separate -->
                <div class="separated-progress">
                  <svg class="semicircular-progress-overlay" width="280" height="160" viewBox="0 0 280 160">
                    
                    <!-- Background semicircle per calorie consumate (esterno) -->
                    <path
                      d="M 20 140 A 120 120 0 0 1 260 140"
                      fill="transparent"
                      stroke="#e0e0e0"
                      stroke-width="16"
                      stroke-linecap="round"
                    />
                    
                    <!-- Progress semicircle per calorie consumate (esterno) -->
                    <path
                      d="M 20 140 A 120 120 0 0 1 260 140"
                      fill="transparent"
                      [attr.stroke]="getCircularProgressColor(dailyStats.calories.percentage)"
                      stroke-width="16"
                      stroke-linecap="round"
                      [style.stroke-dasharray]="377.0"
                      [style.stroke-dashoffset]="consumedCaloriesProgressOffset"
                      class="progress-semicircle consumed-outer"
                    />
                    
                    <!-- Background semicircle per calorie bruciate (interno) -->
                    <path
                      d="M 55 140 A 85 85 0 0 1 225 140"
                      fill="transparent"
                      stroke="#f5f5f5"
                      stroke-width="12"
                      stroke-linecap="round"
                    />
                    
                    <!-- Progress semicircle per calorie bruciate (interno) -->
                    <path
                      d="M 55 140 A 85 85 0 0 1 225 140"
                      fill="transparent"
                      stroke="#ff9800"
                      stroke-width="12"
                      stroke-linecap="round"
                      [style.stroke-dasharray]="267.0"
                      [style.stroke-dashoffset]="burnedCaloriesProgressOffset"
                      class="progress-semicircle burned-inner"
                    />
                    
                  </svg>
                </div>
                
                <!-- Informazioni numeriche posizionate lateralmente -->
                <div class="calories-data-overlay">
                  
                  <!-- Calorie consumate (lato sinistro) -->
                  <div class="calories-info-box consumed-box">
                    <div class="calories-label">MANGIATE</div>
                    <div class="calories-values">
                      <span class="main-value">{{ dailyStats.calories.consumed }}</span>
                      <span class="separator">/</span>
                      <span class="goal-value">{{ dailyStats.calories.adjustedGoal }}</span>
                    </div>
                    <div class="calories-unit">kcal</div>
                  </div>
                  
                  <!-- Calorie bruciate (lato destro) -->
                  <div class="calories-info-box burned-box">
                    <div class="calories-label">BRUCIATE</div>
                    <div class="calories-values">
                      <span class="main-value">{{ dailyStats.calories.burned }}</span>
                    </div>
                    <div class="calories-unit">kcal</div>
                  </div>
                  
                </div>
                
                <!-- Riepilogo centrale sotto le progress bar -->
                <div class="calories-summary-bottom">
                  <div class="remaining-calories" [ngClass]="{
                    'positive': dailyStats.calories.remaining > 0,
                    'negative': dailyStats.calories.remaining <= 0
                  }">
                    <ion-icon [name]="dailyStats.calories.remaining > 0 ? 'checkmark-circle' : 'alert-circle'"></ion-icon>
                    {{ dailyStats.calories.remaining > 0 ? 'Rimangono ' + dailyStats.calories.remaining + ' kcal' : 'Eccesso di ' + getMathAbs(dailyStats.calories.remaining) + ' kcal' }}
                  </div>
                </div>
                
              </div>
            </div>

            <!-- Macronutrienti -->
            <div class="macros-section">

              <!-- Proteine -->
              <div class="macro-item proteins">
                <div class="macro-header">
                  <ion-icon name="fitness-outline" class="macro-icon protein"></ion-icon>
                  <span class="macro-label">Proteine</span>
                  <span class="macro-values">{{ dailyStats.proteins.consumed }}/{{ dailyStats.proteins.goal }}g</span>
                </div>
                <ion-progress-bar 
                  [value]="dailyStats.proteins.percentage / 100"
                  [color]="getProgressColor(dailyStats.proteins.percentage)"
                  class="macro-progress">
                </ion-progress-bar>
              </div>

              <!-- Carboidrati -->
              <div class="macro-item carbs">
                <div class="macro-header">
                  <ion-icon name="restaurant-outline" class="macro-icon carb"></ion-icon>
                  <span class="macro-label">Carboidrati</span>
                  <span class="macro-values">{{ dailyStats.carbs.consumed }}/{{ dailyStats.carbs.goal }}g</span>
                </div>
                <ion-progress-bar 
                  [value]="dailyStats.carbs.percentage / 100"
                  [color]="getProgressColor(dailyStats.carbs.percentage)"
                  class="macro-progress">
                </ion-progress-bar>
              </div>

              <!-- Grassi -->
              <div class="macro-item fats">
                <div class="macro-header">
                  <ion-icon name="water-outline" class="macro-icon fat"></ion-icon>
                  <span class="macro-label">Grassi</span>
                  <span class="macro-values">{{ dailyStats.fats.consumed }}/{{ dailyStats.fats.goal }}g</span>
                </div>
                <ion-progress-bar 
                  [value]="dailyStats.fats.percentage / 100"
                  [color]="getProgressColor(dailyStats.fats.percentage)"
                  class="macro-progress">
                </ion-progress-bar>
              </div>

              <!-- Acqua -->
              <div class="macro-item water">
                <div class="macro-header">
                  <ion-icon name="fitness-outline" class="macro-icon water"></ion-icon>
                  <span class="macro-label">Acqua</span>
                  <span class="macro-values">{{ dailyStats.water.consumed }}/{{ dailyStats.water.goal }}ml</span>
                </div>
                <ion-progress-bar 
                  [value]="dailyStats.water.percentage / 100"
                  [color]="getProgressColor(dailyStats.water.percentage)"
                  class="macro-progress">
                </ion-progress-bar>
              </div>

            </div>
          </ion-card-content>
        </ion-card>

        <!-- ATTIVITA' REC -->
        <ion-card class="desktop-activities-card" style="box-shadow: none; border: none;">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="trending-up-outline"></ion-icon>
              Attività Recenti
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div *ngIf="recentActivities.length === 0" class="desktop-empty-state">
              <ion-icon name="trending-up-outline" style="color: #ff0000;"></ion-icon>
              <p>Nessuna attività registrata</p>
              <ion-button 
              fill="outline"
              size="small"
              class="action-btn activity-btn"
              (click)="goToActivity()">
              <ion-icon slot="start" name="fitness-outline"></ion-icon>
              + Registra Attività
            </ion-button>
            </div>
            
            <div *ngFor="let activity of recentActivities" class="desktop-activity-item">
              <div class="activity-info">
                <h4>{{ activity.name }}</h4>
                <p>{{ activity.duration_minutes }} min • {{ activity.calories_burned }} kcal</p>
              </div>
              <ion-badge [color]="activity.intensity === 'high' ? 'danger' : activity.intensity === 'moderate' ? 'warning' : 'success'">
                {{ activity.intensity }}
              </ion-badge>
            </div>
          </ion-card-content>
        </ion-card>

      </div>

      <!-- Colonna Destra -->
      <div class="desktop-right-column">
        
        <!-- Gestione Pasti Desktop -->
        <ion-card class="desktop-meals-card desktop-meal-management">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="restaurant-outline"></ion-icon>
              Gestione Pasti
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            
            <!-- 4 Sezioni Pasti con Progress Bar -->
            <div class="meal-management-grid">
              
              <!-- Colazione -->
              <div class="meal-section breakfast">
                <div class="meal-header">
                  <ion-icon name="cafe-outline" class="meal-icon"></ion-icon>
                  <div class="meal-info">
                    <h4 class="meal-name">Colazione</h4>
                    <p class="meal-calories">{{getMealStats('breakfast').calories.consumed}} / {{getMealStats('breakfast').calories.goal}} kcal</p>
                  </div>
                </div>
                <div class="meal-content">
                  <div *ngIf="getMealStats('breakfast').foods.length === 0" class="empty-meal">
                    <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                    <p class="empty-text">Nessun cibo aggiunto</p>
                    <ion-button 
                      fill="solid" 
                      size="small"
                      class="add-meal-btn"
                      (click)="addMeal('breakfast')">
                      <ion-icon name="add-outline"></ion-icon>
                      Aggiungi
                    </ion-button>
                  </div>
                  
                  <!-- Progress Bars Macronutrienti -->
                  <div *ngIf="getMealStats('breakfast').foods.length > 0" class="meal-progress">
                    <div class="macro-progress-item">
                      <span class="macro-label">Calorie</span>
                      <ion-progress-bar 
                        [value]="getMealStats('breakfast').calories.percentage / 100"
                        [color]="getProgressColor(getMealStats('breakfast').calories.percentage)">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('breakfast').calories.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Carb</span>
                      <ion-progress-bar 
                        [value]="getMealStats('breakfast').carbs.percentage / 100"
                        color="primary">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('breakfast').carbs.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Prot</span>
                      <ion-progress-bar 
                        [value]="getMealStats('breakfast').proteins.percentage / 100"
                        color="success">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('breakfast').proteins.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Grassi</span>
                      <ion-progress-bar 
                        [value]="getMealStats('breakfast').fats.percentage / 100"
                        color="warning">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('breakfast').fats.percentage}}%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Pranzo -->
              <div class="meal-section lunch">
                <div class="meal-header">
                  <ion-icon name="restaurant-outline" class="meal-icon"></ion-icon>
                  <div class="meal-info">
                    <h4 class="meal-name">Pranzo</h4>
                    <p class="meal-calories">{{getMealStats('lunch').calories.consumed}} / {{getMealStats('lunch').calories.goal}} kcal</p>
                  </div>
                </div>
                <div class="meal-content">
                  <div *ngIf="getMealStats('lunch').foods.length === 0" class="empty-meal">
                    <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                    <p class="empty-text">Nessun cibo aggiunto</p>
                    <ion-button 
                      fill="solid" 
                      size="small"
                      class="add-meal-btn"
                      (click)="addMeal('lunch')">
                      <ion-icon name="add-outline"></ion-icon>
                      Aggiungi
                    </ion-button>
                  </div>
                  
                  <!-- Progress Bars Macronutrienti -->
                  <div *ngIf="getMealStats('lunch').foods.length > 0" class="meal-progress">
                    <div class="macro-progress-item">
                      <span class="macro-label">Calorie</span>
                      <ion-progress-bar 
                        [value]="getMealStats('lunch').calories.percentage / 100"
                        [color]="getProgressColor(getMealStats('lunch').calories.percentage)">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('lunch').calories.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Carb</span>
                      <ion-progress-bar 
                        [value]="getMealStats('lunch').carbs.percentage / 100"
                        color="primary">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('lunch').carbs.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Prot</span>
                      <ion-progress-bar 
                        [value]="getMealStats('lunch').proteins.percentage / 100"
                        color="success">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('lunch').proteins.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Grassi</span>
                      <ion-progress-bar 
                        [value]="getMealStats('lunch').fats.percentage / 100"
                        color="warning">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('lunch').fats.percentage}}%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Spuntino -->
              <div class="meal-section snack">
                <div class="meal-header">
                  <ion-icon name="pizza-outline" class="meal-icon"></ion-icon>
                  <div class="meal-info">
                    <h4 class="meal-name">Spuntino</h4>
                    <p class="meal-calories">{{getMealStats('snack').calories.consumed}} / {{getMealStats('snack').calories.goal}} kcal</p>
                  </div>
                </div>
                <div class="meal-content">
                  <div *ngIf="getMealStats('snack').foods.length === 0" class="empty-meal">
                    <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                    <p class="empty-text">Nessun cibo aggiunto</p>
                    <ion-button 
                      fill="solid" 
                      size="small"
                      class="add-meal-btn"
                      (click)="addMeal('snack')">
                      <ion-icon name="add-outline"></ion-icon>
                      Aggiungi
                    </ion-button>
                  </div>
                  
                  <!-- Progress Bars Macronutrienti -->
                  <div *ngIf="getMealStats('snack').foods.length > 0" class="meal-progress">
                    <div class="macro-progress-item">
                      <span class="macro-label">Calorie</span>
                      <ion-progress-bar 
                        [value]="getMealStats('snack').calories.percentage / 100"
                        [color]="getProgressColor(getMealStats('snack').calories.percentage)">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('snack').calories.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Carb</span>
                      <ion-progress-bar 
                        [value]="getMealStats('snack').carbs.percentage / 100"
                        color="primary">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('snack').carbs.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Prot</span>
                      <ion-progress-bar 
                        [value]="getMealStats('snack').proteins.percentage / 100"
                        color="success">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('snack').proteins.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Grassi</span>
                      <ion-progress-bar 
                        [value]="getMealStats('snack').fats.percentage / 100"
                        color="warning">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('snack').fats.percentage}}%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Cena -->
              <div class="meal-section dinner">
                <div class="meal-header">
                  <ion-icon name="moon-outline" class="meal-icon"></ion-icon>
                  <div class="meal-info">
                    <h4 class="meal-name">Cena</h4>
                    <p class="meal-calories">{{getMealStats('dinner').calories.consumed}} / {{getMealStats('dinner').calories.goal}} kcal</p>
                  </div>
                </div>
                <div class="meal-content">
                  <div *ngIf="getMealStats('dinner').foods.length === 0" class="empty-meal">
                    <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                    <p class="empty-text">Nessun cibo aggiunto</p>
                    <ion-button 
                      fill="solid" 
                      size="small"
                      class="add-meal-btn"
                      (click)="addMeal('dinner')">
                      <ion-icon name="add-outline"></ion-icon>
                      Aggiungi
                    </ion-button>
                  </div>
                  
                  <!-- Progress Bars Macronutrienti -->
                  <div *ngIf="getMealStats('dinner').foods.length > 0" class="meal-progress">
                    <div class="macro-progress-item">
                      <span class="macro-label">Calorie</span>
                      <ion-progress-bar 
                        [value]="getMealStats('dinner').calories.percentage / 100"
                        [color]="getProgressColor(getMealStats('dinner').calories.percentage)">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('dinner').calories.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Carb</span>
                      <ion-progress-bar 
                        [value]="getMealStats('dinner').carbs.percentage / 100"
                        color="primary">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('dinner').carbs.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Prot</span>
                      <ion-progress-bar 
                        [value]="getMealStats('dinner').proteins.percentage / 100"
                        color="success">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('dinner').proteins.percentage}}%</span>
                    </div>
                    <div class="macro-progress-item">
                      <span class="macro-label">Grassi</span>
                      <ion-progress-bar 
                        [value]="getMealStats('dinner').fats.percentage / 100"
                        color="warning">
                      </ion-progress-bar>
                      <span class="macro-percentage">{{getMealStats('dinner').fats.percentage}}%</span>
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
            
          </ion-card-content>
        </ion-card>


         <!-- Attività Recenti Desktop -->
         <ion-card class="desktop-activities-card" style="box-shadow: none; border: none;">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="trending-up-outline"></ion-icon>
              Azioni Rapide
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="button-container">
              <ion-button 
              fill="solid" 
              class="action-btn scan-btn"
              [routerLink]="['/scanner']">
              <ion-icon slot="start" name="barcode-outline"></ion-icon>
              Scansiona prodotto
            </ion-button>
          
          <ion-button 
              fill="solid" 
              class="action-btn pantry-btn"
              [routerLink]="['/pantry']">
              <ion-icon slot="start" name="fast-food-outline"></ion-icon>
              Dispensa
          </ion-button>


          <ion-button 
          fill="solid" 
          class="action-btn vals-btn"
          [routerLink]="['/vals']">
          <ion-icon slot="start" name="stats-chart-outline"></ion-icon>
          I miei valori
      </ion-button>
          
          <!--
            <ion-button 
                fill="solid" 
                class="action-btn water-btn"
                expand="block">
                  <ion-icon slot="start" name="water-outline"></ion-icon>
                  Bevi acqua
            </ion-button> -->
          </div>
        </ion-card-content>

        <ion-item>
          <!-- Casella di testo -->
          <ion-item>
            <ion-input 
              type="number" 
              [formControl]="waterAmount"
              label="ml">
            </ion-input>
          </ion-item>
        
          <!-- Pulsante accanto
          <ion-button (click)="confirmWater()">
            Conferma
          </ion-button> -->
          <ion-button 
                fill="solid" 
                class="action-btn water-btn"
                expand="block"
                (click)="addWater()">
                  <ion-icon slot="start" name="water-outline"></ion-icon>
                  Bevi acqua
            </ion-button>
        </ion-item>
        <ion-item>
          <ion-button 
                fill="solid" 
                class="bicchiere-btn"
                expand="block"
                (click)="waterForm.get('waterAmount')?.setValue(100); confirmWater()">
                  Bicchiere piccolo (100ml)
            </ion-button>
            <ion-button 
                fill="solid" 
                class="bicchiere-btn"
                expand="block"
                (click)="waterForm.get('waterAmount')?.setValue(250); confirmWater()">
                  Bicchiere medio (250ml)
            </ion-button>
            <ion-button 
                fill="solid" 
                class="bicchiere-btn"
                expand="block"
                (click)="waterForm.get('waterAmount')?.setValue(500); confirmWater()">
                  Bottiglietta (500ml)
            </ion-button>
        </ion-item>
        <ion-item>
          <!-- Casella di testo -->
          <ion-item>
            <ion-input 
              type="number" 
              [formControl]="waterAmount"
              label="kg">
            </ion-input>
          </ion-item>
        
          <!-- Pulsante accanto
          <ion-button (click)="confirmWater()">
            Conferma
          </ion-button> -->
          <ion-button 
                fill="solid" 
                class="action-btn weight-btn"
                expand="block"
                (click)="addWater()">
                  <ion-icon slot="start" name="scale-outline"></ion-icon>
                  Aggiungi peso giornaliero
            </ion-button>
        </ion-item>
      </ion-card>

        <!-- Attività Recenti Desktop
        <ion-card class="desktop-activities-card" style="box-shadow: none; border: none;">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="trending-up-outline"></ion-icon>
              Attività Recenti
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div *ngIf="recentActivities.length === 0" class="desktop-empty-state">
              <ion-icon name="trending-up-outline" style="color: #ff0000;"></ion-icon>
              <p>Nessuna attività registrata</p>
                <ion-button fill="outline" size="small" style="--ion-color-contrast: #505050;"  (click)="handleQuickAction({action: 'addActivity'})">
                Registra Attività
                </ion-button>
            </div>
            
            <div *ngFor="let activity of recentActivities" class="desktop-activity-item">
              <div class="activity-info">
                <h4>{{ activity.name }}</h4>
                <p>{{ activity.duration_minutes }} min • {{ activity.calories_burned }} kcal</p>
              </div>
              <ion-badge [color]="activity.intensity === 'high' ? 'danger' : activity.intensity === 'moderate' ? 'warning' : 'success'">
                {{ activity.intensity }}
              </ion-badge>
            </div>
          </ion-card-content>
        </ion-card>   -->
      </div>
    </div>
  </div>

  <!-- Layout Mobile (esistente) -->
  <div *ngIf="!isDesktop" class="mobile-layout">
    <!-- Header con benvenuto e navigazione temporale -->
    <div class="welcome-header">
      <div class="welcome-content">
        <h1>{{ getWelcomeMessage() }}</h1>
        <p *ngIf="user">{{ user.name }}!</p>
        <p class="welcome-subtitle">Ecco il tuo riepilogo</p>
        
        <!-- Controlli di navigazione temporale mobile -->
        <div class="mobile-date-navigation" style="margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <ion-button 
            fill="clear" 
            size="small" 
            (click)="goToPreviousDay()"
            style="--color: #ffffff; color: #ffffff !important;">
            <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
          </ion-button>
          
          <div class="mobile-date-display" style="flex: 1; text-align: center; color: #ffffff; font-weight: 500; font-size: 1rem; padding: 0 8px;">
            {{ getDateDisplayText() }}
          </div>
          
          <ion-button 
            fill="clear" 
            size="small" 
            (click)="goToNextDay()"
            [disabled]="!canGoToNextDay()"
            style="--color: #ffffff; color: #ffffff !important;">
            <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        
        <ion-button 
          *ngIf="!isToday()"
          fill="outline" 
          size="small" 
          (click)="goToToday()"
          style="margin-top: 12px; --border-color: #ffffff; --color: #ffffff; border-color: #ffffff !important; color: #ffffff !important; font-size: 0.9rem;">
          Torna a Oggi
        </ion-button>
      </div>
    </div>

    <!-- Segment per scegliere la vista -->
    <ion-segment 
      [(ngModel)]="selectedSegment" 
      class="dashboard-segment">
      <ion-segment-button value="nutrition">
        <ion-label>Nutrizione</ion-label>
        <ion-icon name="nutrition-outline"></ion-icon>
      </ion-segment-button>
      <ion-segment-button value="activity">
        <ion-label>Attività</ion-label>
        <ion-icon name="trending-up-outline"></ion-icon>
      </ion-segment-button>
    </ion-segment>

    <!-- Vista Nutrizione Mobile -->
    <div *ngIf="selectedSegment === 'nutrition'" class="content-section">
      
      <!-- Calorie Card -->
      <ion-card class="nutrition-card calories-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="flame-outline" class="card-icon"></ion-icon>
            Calorie Giornaliere
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="stat-display">
            <div class="stat-numbers">
              <span class="current">{{ dailyStats.calories.consumed }}</span>
              <span class="separator">/</span>
              <span class="goal">{{ dailyStats.calories.goal }}</span>
              <span class="unit">kcal</span>
            </div>
            <ion-progress-bar 
              [value]="dailyStats.calories.percentage / 100"
              [color]="getProgressColor(dailyStats.calories.percentage)"
              class="stat-progress">
            </ion-progress-bar>
            <div class="stat-percentage">
              {{ dailyStats.calories.percentage.toFixed(0) }}% dell'obiettivo
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Macronutrienti Grid Mobile -->
      <ion-grid class="macros-grid">
        <ion-row>
          <!-- Carboidrati -->
          <ion-col size="12" size-md="4">
            <ion-card class="macro-card carbs">
              <ion-card-content>
                <div class="macro-header">
                  <ion-icon name="nutrition-outline"></ion-icon>
                  <span>Carboidrati</span>
                </div>
                <div class="macro-value">
                  {{ dailyStats.carbs.consumed }}g / {{ dailyStats.carbs.goal }}g
                </div>
                <ion-progress-bar 
                  [value]="dailyStats.carbs.percentage / 100"
                  [color]="getProgressColor(dailyStats.carbs.percentage)">
                </ion-progress-bar>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <!-- Proteine -->
          <ion-col size="12" size-md="4">
            <ion-card class="macro-card proteins">
              <ion-card-content>
                <div class="macro-header">
                  <ion-icon name="fitness-outline"></ion-icon>
                  <span>Proteine</span>
                </div>
                <div class="macro-value">
                  {{ dailyStats.proteins.consumed }}g / {{ dailyStats.proteins.goal }}g
                </div>
                <ion-progress-bar 
                  [value]="dailyStats.proteins.percentage / 100"
                  [color]="getProgressColor(dailyStats.proteins.percentage)">
                </ion-progress-bar>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <!-- Grassi -->
          <ion-col size="12" size-md="4">
            <ion-card class="macro-card fats">
              <ion-card-content>
                <div class="macro-header">
                  <ion-icon name="water-outline"></ion-icon>
                  <span>Grassi</span>
                </div>
                <div class="macro-value">
                  {{ dailyStats.fats.consumed }}g / {{ dailyStats.fats.goal }}g
                </div>
                <ion-progress-bar 
                  [value]="dailyStats.fats.percentage / 100"
                  [color]="getProgressColor(dailyStats.fats.percentage)">
                </ion-progress-bar>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Acqua -->
      <ion-card class="water-card">
        <ion-card-content>
          <div class="water-header">
            <ion-icon name="water-outline" class="water-icon"></ion-icon>
            <h3>Idratazione</h3>
            <ion-button 
              fill="clear" 
              size="small" 
              color="primary"
              (click)="addWater()">
              <ion-icon name="add-outline"></ion-icon>
              250ml
            </ion-button>
          </div>
          <div class="water-progress">
            <div class="water-amount">
              {{ dailyStats.water.consumed }}ml / {{ dailyStats.water.goal }}ml
            </div>
            <ion-progress-bar 
              [value]="dailyStats.water.consumed / dailyStats.water.goal"
              color="primary">
            </ion-progress-bar>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Gestione Pasti Mobile -->
      <ion-card class="recent-meals-card mobile-meal-management">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="restaurant-outline"></ion-icon>
            Gestione Pasti
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          
          <div class="meal-management-grid">
            
            <!-- Colazione -->
            <div class="meal-section breakfast">
              <div class="meal-header">
                <ion-icon name="cafe-outline" class="meal-icon"></ion-icon>
                <div class="meal-info">
                  <h4 class="meal-name">Colazione</h4>
                  <p class="meal-calories">{{getMealStats('breakfast').calories.consumed}} / {{getMealStats('breakfast').calories.goal}} kcal</p>
                </div>
              </div>
              <div class="meal-content">
                <div *ngIf="getMealStats('breakfast').foods.length === 0" class="empty-meal">
                  <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                  <p class="empty-text">Nessun cibo aggiunto</p>
                  <ion-button 
                    fill="solid" 
                    size="small"
                    class="add-meal-btn"
                    (click)="addMeal('breakfast')">
                    <ion-icon name="add-outline"></ion-icon>
                    Aggiungi
                  </ion-button>
                </div>
                
                <!-- Progress Bars Macronutrienti -->
                <div *ngIf="getMealStats('breakfast').foods.length > 0" class="meal-progress">
                  <div class="macro-progress-item">
                    <span class="macro-label">Calorie</span>
                    <ion-progress-bar 
                      [value]="getMealStats('breakfast').calories.percentage / 100"
                      [color]="getProgressColor(getMealStats('breakfast').calories.percentage)">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('breakfast').calories.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Carb</span>
                    <ion-progress-bar 
                      [value]="getMealStats('breakfast').carbs.percentage / 100"
                      color="primary">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('breakfast').carbs.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Prot</span>
                    <ion-progress-bar 
                      [value]="getMealStats('breakfast').proteins.percentage / 100"
                      color="success">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('breakfast').proteins.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Grassi</span>
                    <ion-progress-bar 
                      [value]="getMealStats('breakfast').fats.percentage / 100"
                      color="warning">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('breakfast').fats.percentage}}%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Pranzo -->
            <div class="meal-section lunch">
              <div class="meal-header">
                <ion-icon name="restaurant-outline" class="meal-icon"></ion-icon>
                <div class="meal-info">
                  <h4 class="meal-name">Pranzo</h4>
                  <p class="meal-calories">{{getMealStats('lunch').calories.consumed}} / {{getMealStats('lunch').calories.goal}} kcal</p>
                </div>
              </div>
              <div class="meal-content">
                <div *ngIf="getMealStats('lunch').foods.length === 0" class="empty-meal">
                  <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                  <p class="empty-text">Nessun cibo aggiunto</p>
                  <ion-button 
                    fill="solid" 
                    size="small"
                    class="add-meal-btn"
                    (click)="addMeal('lunch')">
                    <ion-icon name="add-outline"></ion-icon>
                    Aggiungi
                  </ion-button>
                </div>
                
                <!-- Progress Bars Macronutrienti -->
                <div *ngIf="getMealStats('lunch').foods.length > 0" class="meal-progress">
                  <div class="macro-progress-item">
                    <span class="macro-label">Calorie</span>
                    <ion-progress-bar 
                      [value]="getMealStats('lunch').calories.percentage / 100"
                      [color]="getProgressColor(getMealStats('lunch').calories.percentage)">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('lunch').calories.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Carb</span>
                    <ion-progress-bar 
                      [value]="getMealStats('lunch').carbs.percentage / 100"
                      color="primary">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('lunch').carbs.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Prot</span>
                    <ion-progress-bar 
                      [value]="getMealStats('lunch').proteins.percentage / 100"
                      color="success">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('lunch').proteins.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Grassi</span>
                    <ion-progress-bar 
                      [value]="getMealStats('lunch').fats.percentage / 100"
                      color="warning">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('lunch').fats.percentage}}%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Spuntino -->
            <div class="meal-section snack">
              <div class="meal-header">
                <ion-icon name="pizza-outline" class="meal-icon"></ion-icon>
                <div class="meal-info">
                  <h4 class="meal-name">Spuntino</h4>
                  <p class="meal-calories">{{getMealStats('snack').calories.consumed}} / {{getMealStats('snack').calories.goal}} kcal</p>
                </div>
              </div>
              <div class="meal-content">
                <div *ngIf="getMealStats('snack').foods.length === 0" class="empty-meal">
                  <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                  <p class="empty-text">Nessun cibo aggiunto</p>
                  <ion-button 
                    fill="solid" 
                    size="small"
                    class="add-meal-btn"
                    (click)="addMeal('snack')">
                    <ion-icon name="add-outline"></ion-icon>
                    Aggiungi
                  </ion-button>
                </div>
                
                <!-- Progress Bars Macronutrienti -->
                <div *ngIf="getMealStats('snack').foods.length > 0" class="meal-progress">
                  <div class="macro-progress-item">
                    <span class="macro-label">Calorie</span>
                    <ion-progress-bar 
                      [value]="getMealStats('snack').calories.percentage / 100"
                      [color]="getProgressColor(getMealStats('snack').calories.percentage)">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('snack').calories.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Carb</span>
                    <ion-progress-bar 
                      [value]="getMealStats('snack').carbs.percentage / 100"
                      color="primary">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('snack').carbs.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Prot</span>
                    <ion-progress-bar 
                      [value]="getMealStats('snack').proteins.percentage / 100"
                      color="success">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('snack').proteins.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Grassi</span>
                    <ion-progress-bar 
                      [value]="getMealStats('snack').fats.percentage / 100"
                      color="warning">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('snack').fats.percentage}}%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Cena -->
            <div class="meal-section dinner">
              <div class="meal-header">
                <ion-icon name="moon-outline" class="meal-icon"></ion-icon>
                <div class="meal-info">
                  <h4 class="meal-name">Cena</h4>
                  <p class="meal-calories">{{getMealStats('dinner').calories.consumed}} / {{getMealStats('dinner').calories.goal}} kcal</p>
                </div>
              </div>
              <div class="meal-content">
                <div *ngIf="getMealStats('dinner').foods.length === 0" class="empty-meal">
                  <ion-icon name="restaurant-outline" class="empty-icon"></ion-icon>
                  <p class="empty-text">Nessun cibo aggiunto</p>
                  <ion-button 
                    fill="solid" 
                    size="small"
                    class="add-meal-btn"
                    (click)="addMeal('dinner')">
                    <ion-icon name="add-outline"></ion-icon>
                    Aggiungi
                  </ion-button>
                </div>
                
                <!-- Progress Bars Macronutrienti -->
                <div *ngIf="getMealStats('dinner').foods.length > 0" class="meal-progress">
                  <div class="macro-progress-item">
                    <span class="macro-label">Calorie</span>
                    <ion-progress-bar 
                      [value]="getMealStats('dinner').calories.percentage / 100"
                      [color]="getProgressColor(getMealStats('dinner').calories.percentage)">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('dinner').calories.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Carb</span>
                    <ion-progress-bar 
                      [value]="getMealStats('dinner').carbs.percentage / 100"
                      color="primary">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('dinner').carbs.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Prot</span>
                    <ion-progress-bar 
                      [value]="getMealStats('dinner').proteins.percentage / 100"
                      color="success">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('dinner').proteins.percentage}}%</span>
                  </div>
                  <div class="macro-progress-item">
                    <span class="macro-label">Grassi</span>
                    <ion-progress-bar 
                      [value]="getMealStats('dinner').fats.percentage / 100"
                      color="warning">
                    </ion-progress-bar>
                    <span class="macro-percentage">{{getMealStats('dinner').fats.percentage}}%</span>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
          
        </ion-card-content>
      </ion-card>

    </div>

    <!-- Vista Attività Mobile -->
    <div *ngIf="selectedSegment === 'activity'" class="content-section">
      
      <!-- Attività oggi -->
      <ion-card class="activity-summary-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="trending-up-outline"></ion-icon>
            Attività di Oggi
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="activity-stats">
            <div class="activity-count">
              <span class="count">{{ dailyStats.activities }}</span>
              <span class="label">Attività Completate</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Attività Recenti -->
      <ion-card class="recent-activities-card">
        <ion-card-header>
          <ion-card-title>Attività Recenti</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div *ngIf="recentActivities.length === 0" class="empty-state">
            <ion-icon name="trending-up-outline" class="empty-icon"></ion-icon>
            <p>Nessuna attività registrata</p>
            <ion-button 
              fill="outline" 
              size="small"
              (click)="handleQuickAction({action: 'addActivity'})">
              Aggiungi Attività
            </ion-button>
          </div>
          
          <ion-item 
            *ngFor="let activity of recentActivities" 
            class="activity-item">
            <ion-icon 
              [name]="'fitness-outline'"
              slot="start"
              [color]="activity.intensity === 'high' ? 'danger' : activity.intensity === 'moderate' ? 'warning' : 'success'">
            </ion-icon>
            <ion-label>
              <h3>{{ activity.name }}</h3>
              <p>{{ activity.duration_minutes }} min • {{ activity.calories_burned }} kcal</p>
            </ion-label>
            <ion-badge 
              slot="end" 
              [color]="activity.intensity === 'high' ? 'danger' : activity.intensity === 'moderate' ? 'warning' : 'success'">
              {{ activity.intensity }}
            </ion-badge>
          </ion-item>
        </ion-card-content>
      </ion-card>

    </div>

    <!-- FAB per aggiungere (solo mobile) -->
    <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="isMobile">
      <ion-fab-button color="primary">
        <ion-icon name="add-outline"></ion-icon>
      </ion-fab-button>
      <ion-fab-list side="top">
        <ion-fab-button 
          color="warning" 
          (click)="addMeal('breakfast')"
          title="Aggiungi Colazione">
          <ion-icon name="cafe-outline"></ion-icon>
        </ion-fab-button>
        <ion-fab-button 
          color="success" 
          (click)="addMeal('lunch')"
          title="Aggiungi Pranzo">
          <ion-icon name="restaurant-outline"></ion-icon>
        </ion-fab-button>
        <ion-fab-button 
          color="tertiary" 
          (click)="addMeal('dinner')"
          title="Aggiungi Cena">
          <ion-icon name="wine-outline"></ion-icon>
        </ion-fab-button>
        <ion-fab-button 
          color="medium" 
          (click)="addMeal('snack')"
          title="Aggiungi Spuntino">
          <ion-icon name="fast-food-outline"></ion-icon>
        </ion-fab-button>
        <ion-fab-button 
          color="secondary" 
          (click)="openGeneralMealAdd()"
          title="Aggiungi Pasto Generico">
          <ion-icon name="nutrition-outline"></ion-icon>
        </ion-fab-button>
      </ion-fab-list>
    </ion-fab>
  </div>

</ion-content>